<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Jujutsu Kaisen 3D Turn Battle</title>
  <style>
    body { margin: 0; background: #181818; color: #fff; font-family: sans-serif; }
    #hud { position: fixed; top: 10px; left: 0; right: 0; text-align: center; z-index: 2; }
    #log { height: 90px; overflow-y: auto; background: #222; border-radius: 8px; margin: 10px auto; max-width: 480px; font-size: 15px; padding: 8px;}
    #controls { margin: 12px auto; }
    button { background: #ffe066; color: #222; border: none; border-radius: 5px; font-size: 16px; margin: 0 4px; padding: 10px 20px; cursor: pointer;}
    button:hover { background: #ffd60a; }
    .hpbar { height: 14px; border-radius: 6px; background: #444; margin: 4px 0;}
    .hpval { height: 100%; border-radius: 6px 0 0 6px; background: #6cfa6c;}
  </style>
</head>
<body>
  <div id="hud">
    <div id="status"></div>
    <div id="log"></div>
    <div id="controls"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script>
    // Personagens: Gojo, Yuji, Nanami
    const CHARACTERS = [
      {
        codename: 'gojo',
        name: 'Satoru Gojo',
        color: 0x33c3fa,
        maxhp: 120,
        atk: 34,
        def: 8,
        skills: [{name: 'Infinity Kick', power: 32}, {name: 'Limitless Pulse', power: 45}],
      },
      {
        codename: 'yuji',
        name: 'Yuji Itadori',
        color: 0xfa3333,
        maxhp: 110,
        atk: 29,
        def: 11,
        skills: [{name: 'Divergent Fist', power: 28}, {name: 'Black Flash', power: 42}],
      },
      {
        codename: 'nanami',
        name: 'Kento Nanami',
        color: 0xfaca33,
        maxhp: 105,
        atk: 31,
        def: 13,
        skills: [{name: 'Ratio Strike', power: 30}, {name: 'Overtime', power: 38}],
      }
    ];

    // Escolha dos personagens (player x cpu)
    let player = {...CHARACTERS[0], curhp: CHARACTERS[0].maxhp};
    let cpu = {...CHARACTERS[1], curhp: CHARACTERS[1].maxhp};

    // Seleção inicial
    let gameStarted = false;
    function showCharSelect() {
      let html = `<b>Escolha seu personagem:</b><br>`;
      CHARACTERS.forEach((ch, i) => {
        html += `<button onclick="selectChar(${i})">${ch.name}</button>`;
      });
      document.getElementById('controls').innerHTML = html;
      document.getElementById('status').innerHTML = '';
      document.getElementById('log').innerHTML = '';
    }
    window.selectChar = function(i) {
      player = {...CHARACTERS[i], curhp: CHARACTERS[i].maxhp};
      const cpuIdx = (i+1)%3;
      cpu = {...CHARACTERS[cpuIdx], curhp: CHARACTERS[cpuIdx].maxhp};
      gameStarted = true;
      document.getElementById('log').innerHTML = `<b>Você escolheu ${player.name}.</b><br>Oponente: ${cpu.name}.<br>Seu turno!`;
      updateStatus();
      showPlayerTurn();
    }

    // Batalha por turnos
    let playerTurn = true;
    function showPlayerTurn() {
      if (player.curhp <= 0 || cpu.curhp <= 0) {endBattle(); return;}
      let html = '';
      player.skills.forEach((s, idx) => {
        html += `<button onclick="playerAttack(${idx})">${s.name}</button>`;
      });
      document.getElementById('controls').innerHTML = html;
    }
    window.playerAttack = function(skillIdx) {
      const skill = player.skills[skillIdx];
      let dano = skill.power + Math.floor(Math.random()*6) - cpu.def;
      if (dano < 0) dano = 0;
      cpu.curhp -= dano;
      if (cpu.curhp < 0) cpu.curhp = 0;
      logMsg(`<span style="color:#6cfa6c;"><b>${player.name}</b> usou <b>${skill.name}</b>! Causou <b>${dano}</b> de dano.</span>`);
      updateStatus();
      setTimeout(cpuTurn, 1500);
    }
    function cpuTurn() {
      if (player.curhp <= 0 || cpu.curhp <= 0) {endBattle(); return;}
      // CPU escolhe skill aleatória
      const skillIdx = Math.floor(Math.random() * cpu.skills.length);
      const skill = cpu.skills[skillIdx];
      let dano = skill.power + Math.floor(Math.random()*6) - player.def;
      if (dano < 0) dano = 0;
      player.curhp -= dano;
      if (player.curhp < 0) player.curhp = 0;
      logMsg(`<span style="color:#fa6c6c;"><b>${cpu.name}</b> usou <b>${skill.name}</b>! Causou <b>${dano}</b> de dano.</span>`);
      updateStatus();
      if (player.curhp > 0 && cpu.curhp > 0) {
        setTimeout(showPlayerTurn, 1500);
      } else {
        setTimeout(endBattle, 800);
      }
    }
    function endBattle() {
      document.getElementById('controls').innerHTML = `<button onclick="showCharSelect()">Jogar Novamente</button>`;
      if (player.curhp <= 0 && cpu.curhp <= 0)
        logMsg(`<b>Empate!</b>`);
      else if (player.curhp <= 0)
        logMsg(`<b style="color:#fa6c6c;">Você perdeu!</b>`);
      else
        logMsg(`<b style="color:#6cfa6c;">Você venceu!</b>`);
    }
    function logMsg(msg) {
      const log = document.getElementById('log');
      log.innerHTML = msg + '<br>' + log.innerHTML;
    }
    function updateStatus() {
      let bar = (hp, max) => `<div class="hpbar"><div class="hpval" style="width:${Math.max(0, hp/max*100)}%;"></div></div>`;
      document.getElementById('status').innerHTML =
        `<b>${player.name}</b> HP: ${player.curhp}/${player.maxhp}${bar(player.curhp, player.maxhp)}<br>
         <b>${cpu.name}</b> HP: ${cpu.curhp}/${cpu.maxhp}${bar(cpu.curhp, cpu.maxhp)}`;
    }

    // Three.js 3D Scene
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    let renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Luz ambiente e direcional
    let light = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(light);
    let dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
    dirLight.position.set(3, 10, 10);
    scene.add(dirLight);

    // Solo
    let plane = new THREE.Mesh(new THREE.PlaneGeometry(12, 8), new THREE.MeshStandardMaterial({color:0x232323}));
    plane.rotation.x = -Math.PI/2;
    scene.add(plane);

    // Modelos 3D Simples (cubos coloridos representando cada personagem)
    let models = {};
    function makeCharModel(char, x) {
      let geo = new THREE.BoxGeometry(1.2, 2.5, 1.2);
      let mat = new THREE.MeshStandardMaterial({color:char.color});
      let mesh = new THREE.Mesh(geo, mat);
      mesh.position.set(x, 1.3, 0);
      scene.add(mesh);
      return mesh;
    }
    function updateModels() {
      // Remove modelos antigos
      Object.values(models).forEach(m => scene.remove(m));
      models.player = makeCharModel(player, -3);
      models.cpu = makeCharModel(cpu, 3);
    }

    // Câmera
    camera.position.set(0,4,10);
    camera.lookAt(0,1,0);

    // Render Loop
    function animate() {
      requestAnimationFrame(animate);
      if (models.player) models.player.rotation.y += 0.01;
      if (models.cpu) models.cpu.rotation.y -= 0.01;
      renderer.render(scene, camera);
    }
    animate();

    // Responsivo
    window.addEventListener('resize',()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Início
    showCharSelect();

    // Atualiza modelos quando o combate começar/novo personagem
    const origSelectChar = window.selectChar;
    window.selectChar = function(idx) {
      origSelectChar(idx);
      updateModels();
    };
  </script>
</body>
</html>
